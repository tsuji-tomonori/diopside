# MADR-001: VTuber配信内容のあいまい検索機能実装

## ステータス

検討中

## コンテキスト

Diopsideアーカイブサイトにおいて、動画タイトルだけでなく配信内容（文字起こし・チャット）を対象とした高度な検索機能を実装する必要がある。

### 要件
- **あいまい検索**: 「親知らず 抜歯」→ 配信内で話題になった医療関連動画を検索
- **表記ゆれ対応**: 「Blue Archive」→「ブルーアーカイブ」「ブルアカ」の動画を検索
- **内容検索**: タイトルだけでなく配信中の発言・チャットコメントから検索
- **サーバレスアーキテクチャ**: AWS Lambda + DynamoDB中心
- **レスポンス性能**: 検索結果を3秒以内で返却

### 制約
- **低ランニングコスト重視**: 月額$20以下を目標
- サーバレスアーキテクチャを維持
- 既存のアーキテクチャとの統合
- オープンソース・無料サービス活用を推奨

## 検討した選択肢

### Option 1: DynamoDB + Lambda フルスキャン検索

**アーキテクチャ:**
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │ -> │  Search API      │ -> │  Search Lambda  │
│   (検索UI)      │    │  (FastAPI)       │    │  (全件検索)     │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         v
                        ┌─────────────────────────────────────────┐
                        │           DynamoDB                      │
                        │  ┌─────────────┐  ┌─────────────────┐  │
                        │  │ Videos      │  │ Transcripts     │  │
                        │  │ Table       │  │ Table           │  │
                        │  └─────────────┘  └─────────────────┘  │
                        └─────────────────────────────────────────┘
```

**データ構造:**
```json
// Transcripts Table
{
  "video_id": "VIDEO001",
  "transcript_type": "SPEECH|CHAT",
  "timestamp": "00:15:30",
  "content": "親知らず抜歯の話をしましょう",
  "speaker": "shirayuki_tomoe|viewer_name",
  "indexed_content": "オヤシラズ バッシ ハナシ", // 読み仮名
  "keywords": ["医療", "手術", "歯科"]
}
```

**検索処理:**
1. 検索クエリを正規化（ひらがな変換、同義語展開）
2. DynamoDB Scan で全Transcriptsレコードを取得
3. Lambda内でN-gram部分マッチング + スコア計算
4. video_idごとに集約してランキング

**利点:**
- シンプルな実装
- DynamoDB中心のアーキテクチャ
- 表記ゆれ対応が可能

**欠点:**
- 大量データでのパフォーマンス問題
- DynamoDB Scanのコスト増大
- スケーラビリティに限界

### Option 2: ベクトル検索 + セマンティック検索

**アーキテクチャ:**
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │ -> │  Search API      │ -> │  Vector Search  │
│   (検索UI)      │    │  (FastAPI)       │    │  Lambda         │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         v
                        ┌─────────────────────────────────────────┐
                        │           DynamoDB                      │
                        │  ┌─────────────┐  ┌─────────────────┐  │
                        │  │ Videos      │  │ Embeddings      │  │
                        │  │ Table       │  │ Table           │  │
                        │  └─────────────┘  └─────────────────┘  │
                        └─────────────────────────────────────────┘
                                    ^
                                    │
                        ┌─────────────────────┐
                        │   OpenAI API        │
                        │   (text-embedding)  │
                        └─────────────────────┘
```

**データ構造:**
```json
// Embeddings Table
{
  "video_id": "VIDEO001",
  "chunk_id": "CHUNK001",
  "content": "親知らず抜歯について話している部分",
  "embedding": [0.1, -0.3, 0.8, ...], // 1536次元ベクトル
  "timestamp_start": "00:15:30",
  "timestamp_end": "00:16:45",
  "content_type": "SPEECH|CHAT"
}
```

**検索処理:**
1. 検索クエリをOpenAI APIでベクトル化
2. DynamoDB Scanで全embeddingを取得
3. Lambda内でコサイン類似度計算
4. 類似度上位の動画を返却

**利点:**
- セマンティック検索で意味的類似性を捉える
- 表記ゆれに強い
- 多言語対応が容易

**欠点:**
- OpenAI APIの外部依存とコスト
- ベクトル計算の処理時間
- DynamoDBでのベクトル検索の非効率性

### Option 3: SQLite + Lambda 低コスト検索 (推奨)

**アーキテクチャ:**
```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   Frontend      │ -> │  Search API      │ -> │  Search Lambda  │
│   (検索UI)      │    │  (FastAPI)       │    │  (SQLite FTS)   │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                                         │
                                                         v
                        ┌─────────────────────────────────────────┐
                        │           Storage Layer                 │
                        │  ┌─────────────┐  ┌─────────────────┐  │
                        │  │ DynamoDB    │  │ S3 Bucket       │  │
                        │  │ (Videos)    │  │ (SQLite Files)  │  │
                        │  └─────────────┘  └─────────────────┘  │
                        └─────────────────────────────────────────┘
```

**データ構造 (SQLite FTS):**
```sql
-- 検索用SQLiteデータベース (S3保存)
CREATE VIRTUAL TABLE search_index USING fts5(
  video_id,
  title,
  transcript_text,
  chat_text,
  keywords,
  content='search_documents',
  tokenize='porter unicode61'
);

-- 同義語テーブル
CREATE TABLE synonyms (
  term TEXT PRIMARY KEY,
  synonyms TEXT -- JSON配列
);
```

**検索処理:**
1. Lambda起動時にS3からSQLiteファイルをダウンロード
2. FTS5のMATCH演算子で高速全文検索
3. 同義語テーブルでクエリ拡張
4. BM25ランキングで結果を返却

**利点:**
- **超低コスト**: S3ストレージ + Lambda実行のみ
- **高速検索**: SQLite FTS5の最適化された検索
- **表記ゆれ対応**: 同義語テーブル + porter tokenizer
- **実装シンプル**: 標準SQLiteライブラリのみ

**欠点:**
- SQLiteファイルのダウンロード時間
- 同時アクセス時のファイル競合

## 決定

**Option 3: SQLite + Lambda 低コスト検索** を採用する。

### 理由

1. **最低コスト**: S3 + Lambdaのみで月額$5-15で実現可能
2. **高速検索**: SQLite FTS5はネイティブレベルで最適化された検索エンジン
3. **表記ゆれ対応**: 同義語テーブルで柔軟なマッチング
4. **シンプル実装**: 標準SQLiteライブラリのみ、外部API不要
5. **既存アーキテクチャとの親和性**: DynamoDB + S3の組み合わせ

## 実装計画

### Phase 1: 基本キーワード検索 (2週間)
1. DynamoDB SearchIndex テーブル作成
2. 文字起こし・チャットデータのインポート処理
3. キーワード検索 Lambda 実装
4. Search API エンドポイント追加

### Phase 2: N-gram インデックス (1週間)
1. 日本語形態素解析 (MeCab/Janome)
2. N-gram インデックス生成
3. 部分マッチ検索の実装

### Phase 3: セマンティック検索 (2週間)
1. OpenAI embeddings 統合
2. ベクトル類似度計算
3. ハイブリッドスコア算出

### Phase 4: パフォーマンス最適化 (1週間)
1. Redis/ElastiCache 導入
2. 検索結果キャッシュ
3. 負荷テスト・調整

## 結果

この決定により以下が実現される:

- **正確な検索**: 「親知らず 抜歯」で関連配信を発見
- **表記ゆれ対応**: 「Blue Archive」→「ブルアカ」のマッチング
- **高速レスポンス**: 3秒以内の検索結果返却
- **スケーラブル**: データ増加に対応可能なアーキテクチャ
- **サーバレス**: AWS Lambda中心の運用

## 補足

### コスト見積り
- DynamoDB: 月額 $50-100 (検索インデックス分)
- Lambda: 月額 $20-50 (検索処理)
- OpenAI API: 月額 $30-80 (embedding生成)
- ElastiCache: 月額 $50-150 (検索キャッシュ)

### 代替案
将来的にデータ量が大幅に増加した場合は、Amazon OpenSearch Service への移行を検討する。
