# タグ階層構造 要件定義書

## 1. 背景

### 1.1 現状の課題
YouTubeでは再生リストによるグルーピングが可能だが、複数の要素による多次元的なグルーピングには対応していない。現在のDiopsideシステムでは429個のユニークタグがフラット構造で管理されており、以下の課題が存在する：

- **検索性の低さ**: 類似したタグが分散して管理されている
- **タグの冗長性**: 関連するタグ間の関係性が明確でない
- **運用コスト**: 新しいタグ作成時の命名規則が不統一

### 1.2 現在のタグ使用状況
分析結果によると、4,009のタグインスタンス中：
- `ゲーム実況`: 697件（17.4%）
- `雑談`: 244件（6.1%）
- `ホラー`: 204件（5.1%）
- 階層構造タグ: `FPS/TPS`のみ（103件）

## 2. 目的

### 2.1 主要目的
複数のタグを階層的に扱うことで、ユーザーが目的別に配信を効率的に探せるシステムを構築する。

### 2.2 副次的目的
- タグ付け作業の効率化
- コンテンツの発見性向上
- メタデータの一貫性確保

## 3. 要件

### 3.1 機能要件

#### 3.1.1 階層構造の自動構築（必須）
以下のルートタグから始まる階層構造を自動的に構築する：

**大分類タグ（必須ルート）**
- ASMR
- お披露目
- イベント
- ゲーム実況
- 企画
- 朗読・声劇
- 歌
- 百合
- 雑談

**追加ルートタグ**
- `shorts`タグをルートとした階層構造
- `tag_analysis_table.csv`記載の分類：
  - ゲーム名
  - 人名
  - グループ名
  - 企画名

#### 3.1.2 階層化ルール（必須）
1. **大分類タグ優先**: 大分類タグが存在する場合は必ずルートレベルに配置
2. **中分類サブタグ**: `docs/design/tag_rule.md`の中分類サブタグを第2階層に配置
3. **具体的コンテンツタグ**: ゲーム名、人名等を適切な階層に配置
4. **階層表記**: `/`（スラッシュ）で階層を区切る（例：`ゲーム実況/ホラー/Cry of Fear`）

#### 3.1.3 自動化処理（必須）
- タグ付け時の手動階層指定は不要
- 既存タグから階層構造を自動推論
- 新規タグの自動分類

### 3.2 非機能要件

#### 3.2.1 パフォーマンス要件
- **読み込み性能の最優先**: 表示時の階層構造読み込みを最適化
- **書き込み性能は二次的**: タグ更新時の処理時間増加は許容

#### 3.2.2 運用要件
- **下位互換性**: 既存のフラットタグとの互換性を維持
- **段階的移行**: 既存データを段階的に階層化
- **エラー処理**: 分類不能なタグの適切な処理

### 3.3 制約事項

#### 3.3.1 技術制約
- DynamoDBのクエリ制限を考慮した設計
- 既存のAPI（`/api/tags`、`/api/videos/by-tag`）との互換性維持
- Next.jsフロントエンドでの階層表示対応

#### 3.3.2 データ制約
- 既存の429ユニークタグすべてを階層化対象とする
- タグ命名規則の統一（`tag_analysis_table.csv`の"note"列に基づく）

## 4. 対象範囲

### 4.1 対象データ
- 全metadataファイル（2019年〜2025年の4,009タグインスタンス）
- `docs/design/tag_rule.md`の中分類サブタグ
- `tag_analysis_table.csv`の分類情報

### 4.2 対象システム
- FastAPI Backend（`package/api/`）
- DynamoDB（タグ関連テーブル）
- Next.js Frontend（`package/web/`）

### 4.3 対象外
- YouTube API連携
- 外部データソースとの同期
- ユーザー独自タグの作成機能

## 5. 成功基準

### 5.1 定量的基準
- 階層化率: 全タグの90%以上を適切な階層に分類
- 読み込み性能: タグツリー取得APIの応答時間500ms以内
- UI表示: 階層タグナビゲーションの表示時間1秒以内

### 5.2 定性的基準
- ユーザーが直感的にコンテンツを発見できる
- タグ管理者の運用負荷が軽減される
- システムの保守性が向上する

## 6. リスク

### 6.1 技術リスク
- **DynamoDB制約**: 複雑なクエリパターンによる性能劣化
- **データ移行**: 既存データの階層化で発生するデータ不整合

### 6.2 運用リスク
- **分類精度**: 自動分類の誤りによるユーザビリティ低下
- **保守性**: 階層ルールの複雑化による保守コスト増加

### 6.3 対策
- 段階的なロールアウト
- フォールバック機能の実装
- 手動修正機能の提供

## 7. 次フェーズ

このフェーズでは基本的な階層構造を実装し、次フェーズで以下を検討：
- ユーザー定義タグ
- AI支援による自動タグ付け
- 動的階層構造の最適化
